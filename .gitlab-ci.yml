stages:
  - build
  - security
  - package
  - deploy

variables:
  # Docker image settings
  DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE
  DOCKER_TAG: $CI_COMMIT_SHA
  DOCKER_LATEST_TAG: latest

  # Docker buildkit for improved caching
  DOCKER_BUILDKIT: 1
  DOCKER_DRIVER: overlay2

  # Node.js version for consistency
  NODE_VERSION: '18.14.2'

# Cache node_modules for faster builds
.node_cache: &node_cache
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
    policy: pull-push

# Build stage - Install dependencies and run tests
build:
  stage: build
  image: node:${NODE_VERSION}-alpine
  <<: *node_cache
  script:
    - echo "Installing dependencies..."
    - npm ci --silent --legacy-peer-deps
    - echo "Running linting..."
    - npm run lint
    - echo "Building application..."
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - staging
    - develop

# Security scan
security:
  stage: security
  image: node:${NODE_VERSION}-alpine
  script:
    - npm audit --audit-level moderate
  allow_failure: true
  only:
    - merge_requests
    - main
    - staging
    - develop

# Docker build stage
docker-build:
  stage: package
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: '/certs'
    DOCKER_DRIVER: overlay2
  before_script:
    # Wait for Docker daemon to be ready
    - until docker info; do sleep 1; done
    # Login to GitLab Container Registry
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    - docker build -t $DOCKER_IMAGE_NAME:$DOCKER_TAG -t $DOCKER_IMAGE_NAME:$DOCKER_LATEST_TAG .
    - echo "Pushing Docker image..."
    - docker push $DOCKER_IMAGE_NAME:$DOCKER_TAG
    - docker push $DOCKER_IMAGE_NAME:$DOCKER_LATEST_TAG
    - echo "Docker image pushed to $DOCKER_IMAGE_NAME:$DOCKER_TAG"
  after_script:
    - docker logout $CI_REGISTRY
  only:
    - main
    - staging
    - develop

# Docker build for merge requests (no push)
docker-build-mr:
  stage: package
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: '/certs'
    DOCKER_DRIVER: overlay2
  before_script:
    # Wait for Docker daemon to be ready
    - until docker info; do sleep 1; done
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "Building Docker image for merge request (no push)..."
    - docker build -t $DOCKER_IMAGE_NAME:mr-$CI_MERGE_REQUEST_IID .
    - echo "Docker image built successfully for MR"
  after_script:
    - docker logout $CI_REGISTRY
  only:
    - merge_requests

# Deploy to staging
deploy-staging:
  stage: deploy
  image: alpine:latest
  variables:
    DEPLOY_ENV: staging
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to staging environment..."
    - echo "Image:$DOCKER_IMAGE_NAME:$DOCKER_TAG"
    - echo "Add your deployment script here"
    - echo "Deployment completed to staging"
  environment:
    name: staging
    url: https://staging.your-domain.com
  only:
    - staging
  when: manual

# Deploy to production
deploy-production:
  stage: deploy
  image: alpine:latest
  variables:
    DEPLOY_ENV: production
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to production environment..."
    - echo "Image:$DOCKER_IMAGE_NAME:$DOCKER_TAG"
    - echo "Add your deployment script here"
    - echo "Deployment completed to production"
  environment:
    name: production
    url: https://your-domain.com
  only:
    - main
  when: manual

# Clean up old container registry images (optional)
cleanup:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Cleaning up old images..."
    - echo "This would require additional setup with GitLab API"
  only:
    - schedules
  when: manual
